<div class="caja-card neo-card-bg">
  <!-- Header de la caja -->
  <div class="caja-header neo-header-gradient">
    <div class="caja-title-section">
      <div class="caja-icon neo-icon-primary">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="caja-details">
        <h3 class="caja-name neo-text-white">{{ cajaData.name }}</h3>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <p class="caja-id neo-text-lavender">{{ cajaData.id }}</p>
          <span class="status-badge neo-badge" [ngClass]="getStatusColor(cajaData.status)">
            <i [ngClass]="getStatusIcon(cajaData.status)"></i>
            {{ cajaData.status.toUpperCase() }}
          </span>
        </div>
      </div>
    </div>

    <!-- Estado compacto de la caja -->
    <div class="caja-status-compact neo-status-section">
      <!-- Mostrar información de reclamo si no está reclamada -->
      <div *ngIf="!cajaData.isClaimed" class="claim-info-section">
        <div class="claim-status">
          <i class="fas fa-key neo-text-warning"></i>
          <span class="neo-text-warning">PENDIENTE DE RECLAMO</span>
        </div>
        <div class="claim-code">
          <span class="neo-text-lavender">Código:</span>
          <span class="claim-code-value neo-text-white">{{ cajaData.claimCode }}</span>
          <button class="copy-code-btn" (click)="copyClaimCode()" title="Copiar código">
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>

      <!-- Mostrar información normal si está reclamada -->
      <div *ngIf="cajaData.isClaimed" class="status-info-section">
        <div class="status-item neo-status-item">
          <i class="fas fa-user neo-icon-secondary"></i>
          <span class="owner-info neo-text-lavender">Propietario:</span>
          <span class="owner-name neo-text-white">{{ cajaData.owner?.firstName }} {{ cajaData.owner?.lastName }}</span>
        </div>

        <div class="status-item neo-status-item">
          <i class="fas fa-clock neo-icon-secondary"></i>
          <span class="last-access-time neo-text-lavender">Última vez abierta</span>
          <span class="last-access-time neo-text-lavender">{{ formatTimeAgo(cajaData.lastAccess) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Acciones principales -->
  <div class="caja-actions-section neo-actions-bg">
    <!-- Mostrar información de código si no está reclamada -->
    <div *ngIf="!cajaData.isClaimed" class="unclaimed-actions">
      <button class="action-button primary neo-btn-primary" (click)="openSensorsModal()" *ngIf="hasSensors()">
        <i class="fas fa-sensors"></i>
        <span>Ver Sensores</span>
        <span class="sensors-badge neo-badge-count">{{ getSensorCount() }}</span>
      </button>
      
      <div class="claim-info-display" *ngIf="!hasSensors()">
        <i class="fas fa-info-circle neo-text-info"></i>
        <span class="neo-text-info">Caja disponible para reclamo</span>
      </div>
    </div>

    <!-- Mostrar información de propietario si está reclamada -->
    <div *ngIf="cajaData.isClaimed" class="claimed-actions">
      <button class="action-button primary neo-btn-primary" (click)="openSensorsModal()" *ngIf="hasSensors()">
        <i class="fas fa-sensors"></i>
        <span>Ver Sensores</span>
        <span class="sensors-badge neo-badge-count">{{ getSensorCount() }}</span>
      </button>
      
      <div class="claimed-info-display" *ngIf="!hasSensors()">
        <i class="fas fa-user-check neo-text-success"></i>
        <span class="neo-text-success">Reclamada por {{ cajaData.owner?.firstName }} {{ cajaData.owner?.lastName }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal para todos los sensores -->
<div class="sensors-modal-overlay neo-modal-overlay" 
     *ngIf="showSensorsModal" 
     (click)="closeSensorsModal()">
  <div class="sensors-modal neo-modal-card" (click)="$event.stopPropagation()">
    <div class="sensors-modal-header neo-modal-header">
      <div class="modal-title">
        <div class="caja-icon-small neo-icon-modal">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div>
          <h3 class="neo-text-primary">{{ cajaData.name }} - Sensores</h3>
          <span class="sensors-count neo-text-meta">{{ getSensorCount() }} de 4 sensores activos</span>
        </div>
      </div>
      <button class="modal-close-btn neo-btn-close" (click)="closeSensorsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="sensors-modal-content neo-modal-content">
      <div class="sensors-grid-modal neo-sensors-grid">
        <div class="sensor-card-modal neo-sensor-card" 
             *ngFor="let sensor of getSensorsList()"
             (click)="openSensorModal(sensor)">
          
          <div class="sensor-icon-modal neo-sensor-icon">
            <i [ngClass]="getSensorIcon(sensor)"></i>
          </div>
          
          <div class="sensor-info-modal">
            <span class="sensor-name neo-text-primary">{{ getSensorTitle(sensor) }}</span>
            <span class="sensor-status neo-status-badge" [ngClass]="getStatusColor(getSensorStatus(sensor))">
              <i [ngClass]="getStatusIcon(getSensorStatus(sensor))"></i>
              {{ getSensorStatus(sensor).toUpperCase() }}
            </span>
            <div class="sensor-value neo-sensor-value" *ngIf="getSensorDisplayValue(sensor)">
              {{ getSensorDisplayValue(sensor) }}
            </div>
          </div>

          <div class="sensor-arrow neo-arrow">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para detalles de sensor individual -->
<div class="sensor-modal-overlay neo-modal-overlay" 
     *ngIf="selectedSensor" 
     (click)="closeSensorModal()">
  <div class="sensor-modal neo-modal-card" (click)="$event.stopPropagation()">
    <div class="sensor-modal-header neo-modal-header">
      <div class="sensor-modal-title">
        <div class="sensor-icon large neo-sensor-icon-large">
          <i [ngClass]="getSensorIcon(selectedSensor)"></i>
        </div>
        <div>
          <h3 class="neo-text-primary">{{ getSensorTitle(selectedSensor) }}</h3>
          <span class="sensor-modal-status neo-status-badge" [ngClass]="getStatusColor(getSensorStatus(selectedSensor))">
            <i [ngClass]="getStatusIcon(getSensorStatus(selectedSensor))"></i>
            {{ getSensorStatus(selectedSensor).toUpperCase() }}
          </span>
        </div>
      </div>
      <button class="modal-close-btn neo-btn-close" (click)="closeSensorModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="sensor-modal-content neo-modal-content">
      
      <!-- Temperature/Humidity Details -->
      <div *ngIf="selectedSensor === 'temperature' || selectedSensor === 'humidity'" class="sensor-detail-content neo-detail-section">
        <div class="detail-row neo-detail-row">
          <span class="neo-text-label">Actual:</span>
          <span class="value-highlight neo-value-highlight">{{ getSensorData(selectedSensor).current }}{{ selectedSensor === 'temperature' ? '°C' : '%' }}</span>
        </div>
        <div class="detail-row neo-detail-row">
          <span class="neo-text-label">Rango permitido:</span>
          <span class="neo-text-value">{{ getSensorData(selectedSensor).min }} - {{ getSensorData(selectedSensor).max }}{{ selectedSensor === 'temperature' ? '°C' : '%' }}</span>
        </div>
        <div class="history-chart neo-history-chart">
          <div class="history-label neo-text-label">Historial de valores:</div>
          <div class="history-bars neo-history-bars">
            <div *ngFor="let value of getSensorData(selectedSensor).history; let i = index" 
                 class="history-bar neo-history-bar"
                 [style.height.px]="getHistoryBarHeight(value, getSensorData(selectedSensor).history)"
                 [title]="value + (selectedSensor === 'temperature' ? '°C' : '%')">
            </div>
          </div>
        </div>
      </div>

      <!-- Camera Details -->
      <div *ngIf="selectedSensor === 'camera'" class="sensor-detail-content neo-detail-section">
        <div class="detail-row neo-detail-row">
          <span class="neo-text-label">Estado:</span>
          <span class="neo-text-value" [ngClass]="getSensorData('camera').status === 'normal' ? (getSensorData('camera').isRecording ? 'text-danger' : 'text-success') : 'text-muted'">
            <i [ngClass]="getSensorData('camera').status === 'normal' ? (getSensorData('camera').isRecording ? 'fas fa-video' : 'fas fa-camera') : 'fas fa-camera-slash'"></i>
            {{ getSensorData('camera').status === 'normal' ? (getSensorData('camera').isRecording ? 'GRABANDO' : 'ACTIVA') : 'NO DISPONIBLE' }}
          </span>
        </div>
        <div class="detail-row neo-detail-row">
          <span class="neo-text-label">Resolución:</span>
          <span class="neo-text-value">{{ getSensorData('camera').resolution }}{{ getSensorData('camera').fps > 0 ? ' @ ' + getSensorData('camera').fps + 'fps' : '' }}</span>
        </div>
        <div class="detail-row neo-detail-row">
          <span class="neo-text-label">Almacenamiento:</span>
          <span class="neo-text-value">{{ getSensorData('camera').storageTotal > 0 ? getSensorData('camera').storageUsed + '% (' + getSensorData('camera').storageUsed + '/' + getSensorData('camera').storageTotal + ' GB)' : 'No disponible' }}</span>
        </div>
        
        <!-- Camera Preview - Solo funcional para caja 1 -->
        <div class="camera-preview neo-camera-section" *ngIf="cajaData.id === 'SF-001' && getSensorData('camera').status === 'normal'">
          <div class="camera-feed neo-camera-feed">
            <img 
              src="https://bride-ensemble-oak-ty.trycloudflare.com/?action=stream" 
              alt="Vista en vivo de la cámara"
              class="camera-stream"
              (error)="onCameraError($event)"
              (load)="onCameraLoad($event)"
              loading="lazy">
            <div class="camera-placeholder neo-camera-placeholder" *ngIf="cameraError" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center;">
              <i class="fas fa-exclamation-triangle" style="color: #ff6b6b; font-size: 2rem; margin-bottom: 1rem;"></i>
              <p style="color: #fff; margin: 0;">Error al cargar la cámara</p>
              <small style="color: #ccc;">Verificando conexión...</small>
            </div>
            <div class="camera-status" *ngIf="getSensorData('camera').isRecording">
              <div class="rec-indicator"></div>
              <span>REC</span>
            </div>
          </div>
          
          <div class="camera-controls neo-camera-controls">
            <button class="camera-btn neo-camera-btn" title="Captura">
              <i class="fas fa-camera"></i>
            </button>
            <button class="camera-btn neo-camera-btn" 
                    [ngClass]="{ 'recording': getSensorData('camera').isRecording, 'neo-btn-recording': getSensorData('camera').isRecording }"
                    (click)="toggleRecording()"
                    title="Grabar">
              <i [ngClass]="getSensorData('camera').isRecording ? 'fas fa-stop' : 'fas fa-play'"></i>
            </button>
            <button class="camera-btn neo-camera-btn" title="Descargar">
              <i class="fas fa-download"></i>
            </button>
          </div>
        </div>

        <!-- Mensaje para cámaras no funcionales -->
        <div class="camera-offline neo-camera-section" *ngIf="cajaData.id !== 'SF-001' || getSensorData('camera').status !== 'normal'" style="padding: 20px; text-align: center; background: rgba(0,0,0,0.05); border-radius: 8px; border: 2px dashed rgba(0,0,0,0.1);">
          <i class="fas fa-camera-slash" style="color: #6c757d; font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
          <h4 style="color: #6c757d; margin-bottom: 0.5rem;">Cámara no disponible</h4>
          <p style="color: #6c757d; margin: 0; opacity: 0.7;">Esta caja no tiene cámara funcional</p>
        </div>
      </div>

    </div>
  </div>
</div>