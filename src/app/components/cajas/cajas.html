<div class="page-container">
  <app-sidebar></app-sidebar>
  <div class="main-content">
    <!-- Header Section -->
    <div class="content-header">
      <div class="header-container">
        <div class="header-info">
          <h1>Mis Cajas de Seguridad</h1>
          <p>Gestiona todas tus cajas de seguridad con facilidad y control total</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="refreshAllData()" [disabled]="isLoading" [ngClass]="{ 'loading': isLoading }" aria-label="Actualizar datos de las cajas">
            <i class="fas fa-sync-alt" [ngClass]="{ 'fa-spin': isLoading }"></i>
            <span>{{ isLoading ? 'Cargando...' : 'Actualizar' }}</span>
          </button>
          
          <button 
            *ngIf="canAddCaja()"
            class="btn btn-primary" 
            (click)="addCaja()" 
            aria-label="Agregar nueva caja de seguridad">
            <i class="fas fa-plus"></i>
            <span>Agregar Caja</span>
          </button>
          
          <div class="connection-indicator" [ngClass]="{ 'connected': isConnected, 'disconnected': !isConnected }" role="status" aria-live="polite">
            <i [ngClass]="isConnected ? 'fas fa-wifi' : 'fas fa-wifi-slash'"></i>
            <span>{{ isConnected ? 'Conectado' : 'Desconectado' }}</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Content Body -->
    <div class="content-body">
      <!-- Loading state -->
      <div class="loading-state" *ngIf="isLoading">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Cargando datos de sensores...</p>
      </div>

      <!-- Cajas grid con datos reales -->
      <div class="cajas-grid" *ngIf="!isLoading">
        <app-caja 
          *ngFor="let caja of cajasData; trackBy: trackByCajaId" 
          [cajaData]="caja">
        </app-caja>
      </div>

      <!-- Empty state -->
      <div class="empty-state" *ngIf="!isLoading && cajasData.length === 0">
        <div class="empty-icon">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h3>No hay cajas configuradas</h3>
        <p *ngIf="canAddCaja()">Agrega tu primera caja de seguridad para comenzar</p>
        <p *ngIf="!canAddCaja()">No tienes cajas asignadas actualmente</p>
        <button 
          *ngIf="canAddCaja()"
          class="add-caja-btn" 
          (click)="addCaja()">
          <i class="fas fa-plus"></i>
          Agregar Caja
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para agregar nueva caja -->
<div class="add-caja-modal-overlay neo-modal-overlay" 
     *ngIf="showAddCajaModal" 
     (click)="closeAddCajaModal()">
  <div class="add-caja-modal neo-modal-card" (click)="$event.stopPropagation()">
    <div class="add-caja-modal-header neo-modal-header">
      <div class="modal-title">
        <div class="caja-icon-small neo-icon-modal">
          <i class="fas fa-plus"></i>
        </div>
        <div>
          <h3 class="neo-text-primary">Agregar Nueva Caja</h3>
          <span class="neo-text-meta">Configura una nueva caja de seguridad</span>
        </div>
      </div>
      <button class="modal-close-btn neo-btn-close" (click)="closeAddCajaModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="add-caja-modal-content neo-modal-content">
      <form (ngSubmit)="createCaja()" #cajaForm="ngForm">
        <div class="form-group">
          <label for="cajaName" class="form-label neo-text-label">Nombre de la Caja</label>
          <input 
            type="text" 
            id="cajaName"
            [(ngModel)]="newCajaName"
            name="cajaName"
            class="form-input neo-input"
            placeholder="Ej: Caja Fuerte Oficina"
            required
            maxlength="50"
            #nameInput="ngModel">
          <div class="input-error neo-error-text" *ngIf="nameInput.invalid && nameInput.touched">
            El nombre de la caja es requerido
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel neo-btn-secondary" (click)="closeAddCajaModal()">
            Cancelar
          </button>
          <button type="submit" class="btn-create neo-btn-primary" [disabled]="cajaForm.invalid || isCreating">
            <i class="fas fa-plus" *ngIf="!isCreating"></i>
            <i class="fas fa-spinner fa-spin" *ngIf="isCreating"></i>
            {{ isCreating ? 'Creando...' : 'Crear Caja' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>